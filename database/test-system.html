<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test System Integration - Katalog Lelang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .test-result {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-vial text-indigo-600 text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">System Integration Test</h1>
                <p class="text-gray-600">Testing Firebase Integration & CRUD Operations</p>
            </div>

            <!-- Test Results -->
            <div id="testResults" class="space-y-4">
                <!-- Results will be populated here -->
            </div>

            <!-- Action Buttons -->
            <div class="mt-8 flex flex-wrap gap-3 justify-center">
                <button onclick="runAllTests()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                    <i class="fa-solid fa-play mr-2"></i>Run All Tests
                </button>
                <button onclick="testConnection()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                    <i class="fa-solid fa-wifi mr-2"></i>Test Connection
                </button>
                <button onclick="testCRUD()"
                        class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                    <i class="fa-solid fa-database mr-2"></i>Test CRUD
                </button>
                <button onclick="testRealtime()"
                        class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                    <i class="fa-solid fa-sync mr-2"></i>Test Realtime
                </button>
                <button onclick="clearTestData()"
                        class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                    <i class="fa-solid fa-trash mr-2"></i>Clear Test Data
                </button>
            </div>

            <!-- Navigation Links -->
            <div class="mt-8 text-center space-y-2">
                <a href="../index.html" class="inline-flex items-center text-indigo-600 hover:text-indigo-800 font-medium">
                    <i class="fa-solid fa-home mr-2"></i>Beranda
                </a>
                <span class="mx-2 text-gray-400">|</span>
                <a href="../kataloglelang.html" class="inline-flex items-center text-indigo-600 hover:text-indigo-800 font-medium">
                    <i class="fa-solid fa-store mr-2"></i>Katalog
                </a>
                <span class="mx-2 text-gray-400">|</span>
                <a href="../admin/login.html" class="inline-flex items-center text-indigo-600 hover:text-indigo-800 font-medium">
                    <i class="fa-solid fa-lock mr-2"></i>Admin Panel
                </a>
            </div>
        </div>
    </div>

    <!-- Firebase Config -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBLvY4uhXf81G0lFR0LmpKmZCjajubRpRs",
            authDomain: "katalog-lelang-aset.firebaseapp.com",
            databaseURL: "https://katalog-lelang-aset-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "katalog-lelang-aset",
            storageBucket: "katalog-lelang-aset.firebasestorage.app",
            messagingSenderId: "139807373486",
            appId: "1:139807373486:web:593657b916e56a6db3d53f"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const productsRef = database.ref('products');
        const testRef = database.ref('test_products');

        // Load Firebase config script
        const script = document.createElement('script');
        script.src = 'firebase-config.js';
        script.onload = () => {
            addTestResult('firebase-config', 'Firebase Config Loaded', 'success');
        };
        script.onerror = () => {
            addTestResult('firebase-config', 'Failed to load Firebase Config', 'error');
        };
        document.head.appendChild(script);

        let testResults = {};

        function addTestResult(id, message, status = 'info', details = null) {
            testResults[id] = { message, status, details };
            updateTestDisplay();
        }

        function updateTestDisplay() {
            const container = document.getElementById('testResults');
            container.innerHTML = Object.entries(testResults).map(([id, result]) => {
                const statusColors = {
                    success: 'bg-green-50 border-green-200 text-green-800',
                    error: 'bg-red-50 border-red-200 text-red-800',
                    warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
                    info: 'bg-blue-50 border-blue-200 text-blue-800'
                };

                const statusIcons = {
                    success: 'fa-check-circle',
                    error: 'fa-times-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };

                return `
                    <div class="test-result border rounded-lg p-4 ${statusColors[result.status]}">
                        <div class="flex items-start gap-3">
                            <i class="fa-solid ${statusIcons[result.status]} mt-0.5"></i>
                            <div class="flex-1">
                                <div class="font-semibold">${result.message}</div>
                                ${result.details ? `<div class="text-sm mt-1 opacity-75">${result.details}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function runAllTests() {
            addTestResult('run-all', 'Starting all tests...', 'info');
            await testConnection();
            await testCRUD();
            await testRealtime();

            const totalTests = Object.keys(testResults).filter(k => k !== 'run-all').length;
            const passedTests = Object.values(testResults).filter(r => r.status === 'success').length;

            addTestResult('summary', `Tests completed: ${passedTests}/${totalTests} passed`,
                         passedTests === totalTests ? 'success' : 'warning');
        }

        async function testConnection() {
            addTestResult('connection', 'Testing Firebase connection...', 'info');

            try {
                // Test basic connection
                await productsRef.once('value');
                addTestResult('connection', 'Firebase connection successful', 'success');

                // Test config
                if (typeof productDB !== 'undefined') {
                    addTestResult('productdb', 'ProductDB initialized', 'success');
                } else {
                    addTestResult('productdb', 'ProductDB not found', 'error');
                }

            } catch (error) {
                addTestResult('connection', 'Firebase connection failed', 'error', error.message);
            }
        }

        async function testCRUD() {
            addTestResult('crud', 'Testing CRUD operations...', 'info');

            try {
                if (typeof productDB === 'undefined') {
                    addTestResult('crud', 'ProductDB not available', 'error');
                    return;
                }

                // Test CREATE
                const testProduct = {
                    type: "Laptop",
                    model: "Test Laptop CRUD",
                    spec: "Intel Core i5 | RAM 8GB | SSD 256GB",
                    condition: "Normal",
                    user: "Test User",
                    pic: "Test PIC",
                    status: "Lelang",
                    priceOriginal: 10000000,
                    priceAuction: 5000000,
                    images: []
                };

                const createId = await productDB.addProduct(testProduct);
                addTestResult('create', 'CREATE operation successful', 'success', `ID: ${createId}`);

                // Test READ
                const allProducts = await productDB.getAllProducts();
                const createdProduct = allProducts.find(p => p.firebaseId === createId);

                if (createdProduct) {
                    addTestResult('read', 'READ operation successful', 'success', `Found ${allProducts.length} products`);
                } else {
                    addTestResult('read', 'READ operation failed', 'error', 'Product not found');
                }

                // Test UPDATE
                if (createdProduct) {
                    await productDB.updateProduct(createId, {
                        model: "Test Laptop CRUD - Updated",
                        priceAuction: 6000000
                    });

                    const updatedProduct = await productDB.getProduct(createId);
                    if (updatedProduct && updatedProduct.model.includes('Updated')) {
                        addTestResult('update', 'UPDATE operation successful', 'success');
                    } else {
                        addTestResult('update', 'UPDATE operation failed', 'error');
                    }
                }

                // Test DELETE
                await productDB.deleteProduct(createId);
                const deletedProduct = await productDB.getProduct(createId);

                if (!deletedProduct) {
                    addTestResult('delete', 'DELETE operation successful', 'success');
                } else {
                    addTestResult('delete', 'DELETE operation failed', 'error');
                }

                addTestResult('crud', 'All CRUD operations completed', 'success');

            } catch (error) {
                addTestResult('crud', 'CRUD test failed', 'error', error.message);
            }
        }

        async function testRealtime() {
            addTestResult('realtime', 'Testing real-time updates...', 'info');

            try {
                if (typeof productDB === 'undefined') {
                    addTestResult('realtime', 'ProductDB not available', 'error');
                    return;
                }

                let updateReceived = false;

                // Set up listener
                productDB.onProductsChanged((products) => {
                    if (!updateReceived) {
                        updateReceived = true;
                        addTestResult('realtime-listener', 'Real-time listener working', 'success');
                    }
                });

                // Add test product to trigger update
                const testId = await productDB.addProduct({
                    type: "Laptop",
                    model: "Realtime Test",
                    spec: "Test Spec",
                    condition: "Normal",
                    user: "Test",
                    pic: "Test",
                    status: "Lelang",
                    priceOriginal: 1000,
                    priceAuction: 500,
                    images: []
                });

                // Wait for listener
                setTimeout(async () => {
                    if (updateReceived) {
                        addTestResult('realtime', 'Real-time updates working', 'success');
                        // Clean up
                        await productDB.deleteProduct(testId);
                    } else {
                        addTestResult('realtime', 'Real-time updates not working', 'error');
                    }
                }, 3000);

            } catch (error) {
                addTestResult('realtime', 'Real-time test failed', 'error', error.message);
            }
        }

        async function clearTestData() {
            addTestResult('clear', 'Clearing test data...', 'info');

            try {
                // Remove test products (products with "Test" in model)
                const snapshot = await productsRef.once('value');
                const data = snapshot.val();

                if (data) {
                    const testProducts = Object.entries(data).filter(([key, product]) =>
                        product.model && product.model.includes('Test')
                    );

                    for (const [key] of testProducts) {
                        await productsRef.child(key).remove();
                    }

                    addTestResult('clear', `Cleared ${testProducts.length} test products`, 'success');
                } else {
                    addTestResult('clear', 'No data to clear', 'success');
                }

            } catch (error) {
                addTestResult('clear', 'Failed to clear test data', 'error', error.message);
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            addTestResult('init', 'Test system initialized', 'success');
        });
    </script>
</body>
</html>